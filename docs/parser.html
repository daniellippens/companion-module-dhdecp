<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>DHD Export.dpx Parser</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
				background: linear-gradient(135deg, #833ab4 0%, #fd1d1d 50%, #fcb045 100%);
				min-height: 100vh;
				padding: 20px;
			}

			.container {
				max-width: 1400px;
				margin: 0 auto;
			}

			.header {
				background: white;
				border-radius: 12px;
				padding: 30px;
				margin-bottom: 20px;
				box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
			}

			h1 {
				color: #333;
				margin-bottom: 10px;
				font-size: 2em;
			}

			.subtitle {
				color: #666;
				font-size: 1.1em;
				margin-bottom: 20px;
			}

			.upload-area {
				border: 3px dashed #833ab4;
				border-radius: 8px;
				padding: 40px;
				text-align: center;
				background: #f8f9ff;
				cursor: pointer;
				transition: all 0.3s ease;
			}

			.upload-area:hover {
				border-color: #fd1d1d;
				background: #fff5f5;
			}

			.upload-area.dragover {
				border-color: #fcb045;
				background: #fff8f0;
				transform: scale(1.02);
			}

			.upload-icon {
				font-size: 3em;
				margin-bottom: 10px;
			}

			input[type='file'] {
				display: none;
			}

			.btn {
				background: linear-gradient(135deg, #833ab4 0%, #fd1d1d 50%, #fcb045 100%);
				color: white;
				border: none;
				padding: 12px 30px;
				border-radius: 6px;
				font-size: 1em;
				cursor: pointer;
				transition: transform 0.2s ease;
				margin-top: 10px;
			}

			.btn:hover {
				transform: translateY(-2px);
				box-shadow: 0 5px 15px rgba(131, 58, 180, 0.4);
			}

			.results {
				background: white;
				border-radius: 12px;
				padding: 30px;
				box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
				display: none;
			}

			.results.show {
				display: block;
			}

			.stats {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				gap: 15px;
				margin-bottom: 25px;
			}

			.stat-card {
				background: linear-gradient(135deg, #833ab4 0%, #fd1d1d 50%, #fcb045 100%);
				color: white;
				padding: 20px;
				border-radius: 8px;
				text-align: center;
			}

			.stat-number {
				font-size: 2.5em;
				font-weight: bold;
				margin-bottom: 5px;
			}

			.stat-label {
				font-size: 0.9em;
				opacity: 0.9;
			}

			.controls {
				display: flex;
				gap: 15px;
				margin-bottom: 20px;
				flex-wrap: wrap;
				align-items: center;
			}

			.search-box {
				flex: 1;
				min-width: 250px;
				padding: 12px 20px;
				border: 2px solid #e0e0e0;
				border-radius: 6px;
				font-size: 1em;
				transition: border-color 0.3s ease;
			}

			.search-box:focus {
				outline: none;
				border-color: #833ab4;
			}

			.filter-group {
				display: flex;
				gap: 10px;
				flex-wrap: wrap;
			}

			.filter-btn {
				padding: 8px 16px;
				border: 2px solid #833ab4;
				background: white;
				color: #833ab4;
				border-radius: 6px;
				cursor: pointer;
				transition: all 0.3s ease;
				font-size: 0.9em;
			}

			.filter-btn.active {
				background: linear-gradient(135deg, #833ab4 0%, #fd1d1d 100%);
				color: white;
				border-color: #833ab4;
			}

			.export-btn {
				padding: 10px 20px;
				background: #10b981;
				color: white;
				border: none;
				border-radius: 6px;
				cursor: pointer;
				font-size: 0.9em;
				transition: all 0.3s ease;
			}

			.export-btn:hover {
				background: #059669;
			}

			.logic-table {
				width: 100%;
				border-collapse: collapse;
				margin-top: 20px;
			}

			.logic-table thead {
				color: white;
			}

			.logic-table th {
				padding: 15px;
				text-align: left;
				font-weight: 600;
				position: sticky;
				top: 0;
				z-index: 10;
				background: #a33a9e;
			}

			.logic-table th:first-child {
				background: #833ab4;
			}

			.logic-table th:nth-child(2) {
				background: #a33a9e;
			}

			.logic-table th:nth-child(3) {
				background: #c43a78;
			}

			.logic-table th:nth-child(4) {
				background: #e53a52;
			}

			.logic-table th:last-child {
				background: #fcb045;
			}

			.logic-table td {
				padding: 12px 15px;
				border-bottom: 1px solid #e0e0e0;
			}

			.logic-table tbody tr:hover {
				background: #fef7ff;
			}

			.logic-table tbody tr.duplicate-row {
				background: #fff5f5;
			}

			.logic-table tbody tr.duplicate-row:hover {
				background: #fee;
			}

			.logic-table tbody tr.unusable-row {
				opacity: 0.4;
			}

			.logic-table tbody tr.unusable-row:hover {
				opacity: 0.6;
			}

			.hex-value {
				font-family: 'Courier New', monospace;
				color: #999;
				font-weight: 400;
				font-size: 0.9em;
			}

			.decimal-value {
				font-family: 'Courier New', monospace;
				color: #fd1d1d;
				font-weight: 700;
				font-size: 1.2em;
				background: linear-gradient(135deg, #833ab4 0%, #fd1d1d 100%);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				background-clip: text;
			}

			.logic-name {
				color: #333;
			}

			.logic-type {
				display: inline-block;
				padding: 4px 10px;
				border-radius: 4px;
				font-size: 0.85em;
				font-weight: 600;
				background: #f3e8ff;
				color: #833ab4;
			}

			.section-badge {
				display: inline-block;
				padding: 4px 10px;
				border-radius: 4px;
				font-size: 0.85em;
				background: #fff4e6;
				color: #c47a10;
			}

			.no-results {
				text-align: center;
				padding: 40px;
				color: #666;
				font-size: 1.1em;
			}

			.table-container {
				max-height: 600px;
				overflow-y: auto;
				border: 1px solid #e0e0e0;
				border-radius: 8px;
			}

			.error {
				background: #fee;
				color: #c00;
				padding: 15px;
				border-radius: 6px;
				margin-top: 15px;
			}

			@media (max-width: 768px) {
				.controls {
					flex-direction: column;
				}

				.search-box {
					width: 100%;
				}

				.stats {
					grid-template-columns: 1fr;
				}

				.logic-table {
					font-size: 0.9em;
				}

				.logic-table th,
				.logic-table td {
					padding: 10px 8px;
				}
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="header">
				<h1>üéõÔ∏è DHD Export.dpx Parser</h1>
				<p class="subtitle">Upload your Export.dpx file to extract and view all Logic IDs</p>

				<div class="upload-area" id="uploadArea">
					<div class="upload-icon">üìÅ</div>
					<p style="font-size: 1.2em; margin-bottom: 10px; color: #333">
						<strong>Drop your Export.dpx file here</strong>
					</p>
					<p style="color: #666; margin-bottom: 15px">or</p>
					<button class="btn" onclick="document.getElementById('fileInput').click()">Browse Files</button>
					<input type="file" id="fileInput" accept=".dpx" />
				</div>
			</div>

			<div class="results" id="results">
				<h2 style="margin-bottom: 20px; color: #333">üìä Parsed Logic IDs</h2>
				<p style="margin-bottom: 20px; color: #666; font-size: 0.95em">
					üí° <strong>Tip:</strong> Use the
					<span
						style="
							background: linear-gradient(135deg, #833ab4, #fd1d1d);
							-webkit-background-clip: text;
							background-clip: text;
							-webkit-text-fill-color: transparent;
							font-weight: bold;
						"
						>Companion ID</span
					>
					column value when configuring logic actions in your Companion module.
				</p>

				<div class="stats" id="stats"></div>

				<div class="controls">
					<input type="text" class="search-box" id="searchBox" placeholder="üîç Search by name, hex, or decimal ID..." />

					<div class="filter-group" id="filterGroup"></div>

					<button class="export-btn" onclick="exportToCSV()">üíæ Export to CSV</button>
				</div>

				<div class="table-container">
					<table class="logic-table">
						<thead>
							<tr>
								<th>Companion ID ‚ú®</th>
								<th>Hex Address</th>
								<th>Logic Name</th>
								<th>Type</th>
								<th>Section</th>
							</tr>
						</thead>
						<tbody id="tableBody"></tbody>
					</table>
				</div>

				<div class="no-results" id="noResults" style="display: none">
					No results found. Try adjusting your search or filters.
				</div>
			</div>
		</div>

		<script>
			let allLogics = []
			let filteredLogics = []
			let activeFilters = new Set()

			// File upload handling
			const uploadArea = document.getElementById('uploadArea')
			const fileInput = document.getElementById('fileInput')

			uploadArea.addEventListener('click', (e) => {
				// Prevent double-trigger when clicking the button
				if (e.target.tagName !== 'BUTTON') {
					fileInput.click()
				}
			})

			uploadArea.addEventListener('dragover', (e) => {
				e.preventDefault()
				uploadArea.classList.add('dragover')
			})

			uploadArea.addEventListener('dragleave', () => {
				uploadArea.classList.remove('dragover')
			})

			uploadArea.addEventListener('drop', (e) => {
				e.preventDefault()
				uploadArea.classList.remove('dragover')
				const file = e.dataTransfer.files[0]
				if (file) handleFile(file)
			})

			fileInput.addEventListener('change', (e) => {
				const file = e.target.files[0]
				if (file) handleFile(file)
			})

			function handleFile(file) {
				if (!file.name.endsWith('.dpx')) {
					alert('Please upload a .dpx file')
					return
				}

				const reader = new FileReader()
				reader.onload = (e) => {
					try {
						parseFile(e.target.result)
					} catch (error) {
						alert('Error parsing file: ' + error.message)
					}
				}
				reader.readAsText(file)
			}

			function parseFile(content) {
				allLogics = []
				const lines = content.split('\n')
				let currentSection = ''

				for (let line of lines) {
					line = line.trim()

					// Detect section headers
					if (line.startsWith('[') && line.endsWith(']')) {
						currentSection = line.slice(1, -1)
						continue
					}

					// Skip comments and empty lines
					if (line.startsWith(';') || line === '') continue

					// Parse logic entries (format: HexAddress=Name;Type or HexAddress=Name)
					const match = line.match(/^(0x[0-9a-fA-F]+)=(.+)$/)
					if (match) {
						const hexAddress = match[1]
						const rest = match[2]

						// Split by semicolon to get name and type
						const parts = rest.split(';')
						const name = parts[0].trim()
						const type = parts[1] ? parts[1].trim() : ''

						// Convert hex to decimal (extract lower 16 bits)
						const fullValue = parseInt(hexAddress, 16)
						const decimalId = fullValue & 0xffff

						allLogics.push({
							hexAddress,
							decimalId,
							name,
							type,
							section: currentSection,
						})
					}
				}

				displayResults()
			}

			function displayResults() {
				if (allLogics.length === 0) {
					alert('No logic entries found in the file')
					return
				}

				// Detect duplicate Companion IDs
				const idCounts = {}
				allLogics.forEach((logic) => {
					idCounts[logic.decimalId] = (idCounts[logic.decimalId] || 0) + 1
				})
				const duplicateIds = new Set(
					Object.entries(idCounts)
						.filter(([id, count]) => count > 1)
						.map(([id]) => parseInt(id)),
				)

				// Mark duplicates and usability
				allLogics.forEach((logic) => {
					logic.isDuplicate = duplicateIds.has(logic.decimalId)
					// Only Logic.* sections are usable with ECP 0x110E0000
					logic.isUsable = logic.section.startsWith('Logic.')
				})

				// Show results section
				document.getElementById('results').classList.add('show')

				// Update stats
				updateStats(duplicateIds.size)

				// Create filter buttons
				createFilterButtons()

				// Initial display
				filteredLogics = [...allLogics]
				renderTable()

				// Setup search
				document.getElementById('searchBox').addEventListener('input', applyFilters)
			}

			function updateStats(duplicateCount = 0) {
				const types = {}
				const sections = {}
				let usableCount = 0

				allLogics.forEach((logic) => {
					types[logic.type] = (types[logic.type] || 0) + 1
					sections[logic.section] = (sections[logic.section] || 0) + 1
					if (logic.isUsable) usableCount++
				})

				let statsHtml = `
                <div class="stat-card">
                    <div class="stat-number">${usableCount}</div>
                    <div class="stat-label">Usable IDs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${allLogics.length}</div>
                    <div class="stat-label">Total IDs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Object.keys(types).length}</div>
                    <div class="stat-label">Logic Types</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Math.min(...allLogics.map((l) => l.decimalId))}</div>
                    <div class="stat-label">Min ID</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Math.max(...allLogics.map((l) => l.decimalId))}</div>
                    <div class="stat-label">Max ID</div>
                </div>
            `

				if (duplicateCount > 0) {
					statsHtml += `
                <div class="stat-card" style="background: linear-gradient(135deg, #dc2626 0%, #f97316 100%);">
                    <div class="stat-number">${duplicateCount}</div>
                    <div class="stat-label">‚ö†Ô∏è Duplicate IDs</div>
                </div>
            `
				}

				document.getElementById('stats').innerHTML = statsHtml
			}

			function createFilterButtons() {
				// Filter out hex values and empty types - only show human-readable categories
				const types = [...new Set(allLogics.map((l) => l.type))]
					.filter((t) => t !== '' && !t.startsWith('0x') && !/^[0-9a-fA-F]+$/.test(t))
					.sort()

				const filterHtml = types
					.map(
						(type) =>
							`<button class="filter-btn" data-type="${type}" onclick="toggleFilter('${type}')">${type}</button>`,
					)
					.join('')

				document.getElementById('filterGroup').innerHTML = filterHtml
			}

			function toggleFilter(type) {
				const btn = document.querySelector(`[data-type="${type}"]`)

				if (activeFilters.has(type)) {
					activeFilters.delete(type)
					btn.classList.remove('active')
				} else {
					activeFilters.add(type)
					btn.classList.add('active')
				}

				applyFilters()
			}

			function applyFilters() {
				const searchTerm = document.getElementById('searchBox').value.toLowerCase()

				filteredLogics = allLogics.filter((logic) => {
					// Apply type filter
					if (activeFilters.size > 0 && !activeFilters.has(logic.type)) {
						return false
					}

					// Apply search filter
					if (searchTerm) {
						const searchMatch =
							logic.name.toLowerCase().includes(searchTerm) ||
							logic.hexAddress.toLowerCase().includes(searchTerm) ||
							logic.decimalId.toString().includes(searchTerm) ||
							logic.type.toLowerCase().includes(searchTerm) ||
							logic.section.toLowerCase().includes(searchTerm)

						if (!searchMatch) return false
					}

					return true
				})

				renderTable()
			}

			function renderTable() {
				const tbody = document.getElementById('tableBody')
				const noResults = document.getElementById('noResults')

				if (filteredLogics.length === 0) {
					tbody.innerHTML = ''
					noResults.style.display = 'block'
					return
				}

				noResults.style.display = 'none'

				// Sort by decimal ID
				const sorted = [...filteredLogics].sort((a, b) => a.decimalId - b.decimalId)

				const html = sorted
					.map((logic) => {
						const classes = []
						if (logic.isDuplicate) classes.push('duplicate-row')
						if (!logic.isUsable) classes.push('unusable-row')
						return `
                <tr class="${classes.join(' ')}">
                    <td><span class="decimal-value">${logic.decimalId}${logic.isDuplicate ? ' ‚ö†Ô∏è' : ''}</span></td>
                    <td><span class="hex-value">${logic.hexAddress}</span></td>
                    <td><span class="logic-name">${logic.name}</span></td>
                    <td>${logic.type ? `<span class="logic-type">${logic.type}</span>` : '-'}</td>
                    <td><span class="section-badge">${logic.section}</span></td>
                </tr>
            `
					})
					.join('')

				tbody.innerHTML = html
			}

			function exportToCSV() {
				if (filteredLogics.length === 0) {
					alert('No data to export')
					return
				}

				// Create CSV content
				const headers = ['Companion ID', 'Hex Address', 'Logic Name', 'Type', 'Section']
				const rows = filteredLogics.map((logic) => [
					logic.decimalId,
					logic.hexAddress,
					`"${logic.name}"`,
					`"${logic.type}"`,
					`"${logic.section}"`,
				])

				const csv = [headers.join(','), ...rows.map((row) => row.join(','))].join('\n')

				// Download CSV
				const blob = new Blob([csv], { type: 'text/csv' })
				const url = window.URL.createObjectURL(blob)
				const a = document.createElement('a')
				a.href = url
				a.download = 'dhd_logic_ids.csv'
				document.body.appendChild(a)
				a.click()
				document.body.removeChild(a)
				window.URL.revokeObjectURL(url)
			}
		</script>
	</body>
</html>
